<html>
 <head>
    <title>Chat</title>
    <meta content="initial-scale=1, minimum-scale=1, width=device-width" name="viewport">
    <link rel="stylesheet" href="{{ static_url("css/style.css") }}">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.6/socket.io.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.1.0/jquery.magnific-popup.min.js"></script>
 </head>
 <body>
   <script type="text/javascript">
   $(document).ready(function () {

    if ("WebSocket" in window){
	websocket = true;
    }else{
	// no web socket support
	websocket = false;
    }
    $(window).load(function(){
    	$.magnificPopup.open({
    	  items:{
            src: '<div id="login" class="hidden mfp-hide"><form><input type=text required placeholder="Name"><br><input type=text required placeholder="Password"><br><button id="loginbutton">Login</button></form></div>',
            type: 'inline',
          }
        });
    });
    var msg = { event: 'register', };
	var ws = new WebSocket("wss://my-chat-socket.herokuapp.com/");
	setInterval( function(){ws.send(JSON.stringify({ event: 'alive', }));}, 30000 );


	  ws.onopen = function(){
		  //alert("Was connected!");	
		  ws.send(JSON.stringify(msg));	  
	  };
              

	      ws.onmessage = function(evt){
		  var event=JSON.parse(evt.data);
		  //console.log(evt.data);
		  if(event.event=='message'){
		    $('.messages').append('<li>'+event.message+'</li>');
		    console.log('Received message');
		  }
		  if (event.event=='connect'){
		  	$('.messages').append('<li>'+event.user+' connected!</li>');
		  }
	  };



	  document.onkeyup = function(e){
	    if(e.keyCode==13){ 
	  	  if($('#myMessage').val() != ''){
	  	  var messag=$('#myMessage').val().replace(/<\/?[^>]+(>|$)/g,"");
		  if (messag!=''){
		  	msg=JSON.stringify({event: 'message', message:messag,});
		    ws.send(msg);
		  }
          $('#myMessage').val('');
          }
      }	  
	  };

	  $('#sendbutton').on('click', function(){
	  	if($('#myMessage').val() != ''){
	  	   var messag=$('#myMessage').val().replace(/<\/?[^>]+(>|$)/g,"");
	  	   if (messag!=''){
		    msg=JSON.stringify({event: 'message', message:messag,});
		    ws.send(msg);
           $('#myMessage').val('');
       }
	  }
	});

	   ws.onclose = function(){
		   console.log("Connection closed...");
		   alert("Connection closed...")
	   };
    
});
	  
</script>
 <div  class="messageBox">
 <ul class="messages"></ul>
 </div>
 <input type="text" id="myMessage" maxlength="200">
 <button id="sendbutton">Send</button>
 </body>
</html>