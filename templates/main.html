<html>
 <head>
    <title>Chat</title>
    <meta content="initial-scale=1, minimum-scale=1, width=device-width" name="viewport">
    <link rel="stylesheet" href="{{ static_url("css/style.css") }}">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.6/socket.io.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>
 </head>
 <body>
   <script type="text/javascript">
   moment.locale('ru')
   $(document).ready(function () {
    if ("WebSocket" in window){
	websocket = true;
    }else{
	websocket = false;
    }
    var msg = {};
    var key="";
	var id=0;
	//var ws = new WebSocket("wss://my-chat-socket.herokuapp.com/");
	var ws = new WebSocket("ws:/localhost:5000/")

	  ws.onopen = function(){
	  	console.log("Was connected!");
	  	document.getElementById("loginbox").className="lshow";
		$('#register').on('click',function(){
			document.getElementById("loginbox").className="hidden";
			document.getElementById("registerbox").className="rshow";
		});
		$('#registerbutton').on('click', function(){
			if(document.forms["registerbox"]["rname"].value!='' && document.forms["registerbox"]["name"].value!=''){
				msg=JSON.stringify({event:'register', name:document.forms["registerbox"]["rname"].value, email:document.forms["registerbox"]["email"].value, passwd: document.forms["registerbox"]["rpasswd"].value,});
				console.log("Register");
				ws.send(msg);
			}
		});
   		$('#loginbutton').on('click', function(){
	  		if(document.forms["loginbox"]["name"].value!='' && document.forms["loginbox"]["passwd"].value!=''){
	  		msg=JSON.stringify({ event: 'login', name:document.forms["loginbox"]["name"].value, passwd: document.forms["loginbox"]["passwd"].value,});
	  		console.log("Login");
   		    ws.send(msg);
   		}
	  	});
	  };
              

	      ws.onmessage = function(evt){
		  var event=JSON.parse(evt.data);
		  //console.log(evt.data);
		  if(event.event=='message'){
		    if (event.author.id==id){
				$('.messages').append('<li><div><div class="myMessage">'+event.author.name+':  '+event.message+'    <i>'+moment(event.timestamp).calendar()+'</div></div></li>');
				}
				else{
					$('.messages').append('<li><div><div class="otherMessage">'+event.author.name+':  '+event.message+'    <i>'+moment(event.timestamp).calendar()+'</div></div></li>');
				}
				$('.messages').append('<div class="clear"></div>');
		    console.log('Received message');
		  }
		  if (event.event=='connect'){
		  	$('.messages').append('<li style="text-align: center;">'+event.user+' connected!</li>');
		  }
		  if(event.event=='login' && event.errors==0){
		  	key=event.key;
			id=event.id;
		  	console.log(event.key);
            document.getElementById("loginbox").className="hidden";
			console.log("id="+id);
            setInterval( function(){ws.send(JSON.stringify({ event: 'alive', key:key}));}, 30000 );
		  }
          if (event.event=='register'){
			  if (event.status!="OK"){
				  document.getElementById("error").innerHTML=event.error;
			  }
			  else{
				  document.getElementById("registerbox").className="hidden";
				  window.location.reload();
			  }
		  }
          if(event.event=='messagedump'){
			  console.log(event.messages);
            for (var message in event.messages){
				var author=event.messages[message].author;
				console.log(event.messages[message].text);
				if (author.id==id){
				$('.messages').append('<li><div><div class="myMessage">'+author.name+':  '+event.messages[message].text+'    <i>'+moment(event.messages[message].timestamp).calendar()+'</div></div></li>');
				}
				else{
					$('.messages').append('<li><div><div class="otherMessage">'+author.name+':  '+event.messages[message].text+'    <i>'+moment(event.messages[message].timestamp).calendar()+'</div></div></li>');
				}
				$('.messages').append('<div class="clear"></div>');
			}
		  }
	  };



	  document.onkeyup = function(e){
	    if(e.keyCode==13){ 
	  	  if($('#myMessage').val() != ''){
	  	  var messag=$('#myMessage').val().replace(/<\/?[^>]+(>|$)/g,"");
		  if (messag!=''){
		  	msg=JSON.stringify({event: 'message', message:messag, key:key, });
		    ws.send(msg);
		  }
          $('#myMessage').val('');
          }
      }	  
	  };

	  $('#sendbutton').on('click', function(){
	  	if($('#myMessage').val() != ''){
	  	   var messag=$('#myMessage').val().replace(/<\/?[^>]+(>|$)/g,"");
	  	   if (messag!=''){
		    msg=JSON.stringify({event: 'message', message:messag, key:key, });
		    ws.send(msg);
           $('#myMessage').val('');
       }
	  }
	});

	   ws.onclose = function(){
		   console.log("Connection closed...");
		   alert("Connection closed...")
	   };
    
});	  
</script>

<div id="registerbox" class="hidden">
    <form name="registerbox" class="registers" onsubmit="return false;" >
        <input name="rname" type="text" required placeholder="Name" ><br>
	    <p id="error" class="error"><p>
		<input name="email" type="email" required placeholder="Email"><br>
        <input name = "rpasswd" type="password" required placeholder="Password"><br>
        <button id="registerbutton" href="#">Register</button>
    </form>
</div>

<div id="loginbox" class="hidden">
<form name="loginbox" onsubmit="return false;">
	<input id="loginName" name="name" type="text" required placeholder="Name">
	<input id="loginPassword" name="passwd" type="password" autocomplete="current-password" required placeholder="Password">
	<button  id="loginbutton" href="#">Login</button>
	<button id="register" href="#">Registration</button>
</form>
</div>

 <div  class="messageBox">
 <ul class="messages"></ul>
 </div>
 <input type="text" id="myMessage"  style="width: 50%;" maxlength="300">
 <button id="sendbutton">Send</button>
 </body>
</html>
